<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отложенная загрузка</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <section>
        <a href="../14_Throttle_Lazyload.html"><<назад</a>
        <h1>Отложенная загрузка</h1>
        <p>
            Веб-страницы содержат большое количество изображений, которые раздувают размер страниц и влияют на скорость их загрузки. Большинство изображений находятся за пределами первого экрана (за кадром, below the fold), поэтому пользователь увидит их только после того как прокрутит страницу. Это значит, что вы возможно загружаете то, что пользователь никогда не увидит, но потратит на это время и возможно деньги. Загрузка некритического контента также тратит батарею мобильных устройств и другие системные ресурсы.
<br><br>
Термины «above the fold» (в кадре) и «below the fold» (за кадром) пришли из времен до появления цифровых технологий. Если вы когда-либо покупали газету в киоске, их обычно складывают пополам, чтобы прохожие могли видеть только верхнюю половину первой страницы. Если им не понравится то, что они увидят, они пройдут мимо, и продажи упадут. Вот почему так важно размещать наиболее интересный контент в верхней части страницы.
<br><br>
Отложенная загрузка (lazy-loading) - это приём, который откладывает загрузку некритических ресурсов во время загрузки страницы. Вместо этого, эти некритические ресурсы загружаются только по необходимости. Это снижает начальный вес ресурсов которые необходимо загрузить для отображения страницы, использование системных ресурсов, повышает время её загрузки и последущего рендера. Все это положительно сказывается на производительности.
<br><br>
Вы, наверное, уже видели в действии ленивую загрузку. Она выглядит примерно так:
<br><br>
Вы попадаете на страницу и начинаете прокручивать её по мере чтения содержимого.
В какой-то момент вы прокручиваете страницу до изображения-заглушки.
Изображение-заглушка внезапно заменяется настоящим изображением.

<h2>Атрибут loading</h2>
<br>
Раньше разработчикам приходилось полагаться только на возможности JavaScript. Современные браузеры умеют делать это без JavaScript, но, к сожалению, не все. HTML-атрибут loading тега img поддерживается нативно во всех современных браузерах кроме Safari и позволяет браузеру отложить загрузку закадровых изображений до тех пор, пока пользователь не прокрутит до них страницу.
<br>
<code>
  img src="" loading="lazy" alt="Image description" /
</code>
<br>
Поддерживает три значения:

<ul>
  <li>lazy - браузер выполнит отложенную загрузку изображения.</li>
  <li>eager - изображение будет загружено при первой возможности, то есть без отложенной загрузки.
</li>
  <li>auto - браузер сам определяет, выполнять отложенную загрузку или нет. Значение по умолчанию.
</li>
</ul>
<br>Мы не можем узнать или изменить поведение и механизм определения времени отложенной загрузки изображения браузером. Главное, что браузер загрузит такие изображения незадолго до того, как они попадут в область просмотра.

Откройте вкладку Network в инструментах разработчика и выберите фильтр Img, чтобы отображалась только загрузка изображений. После этого прокручивайте пример и наблюдайте как будут догружаться закадровые изображения котов. Браузеры поддерживающие атрибут loading будут загружать изображения отложенно, а браузеры без поддержки загрузят все изображения сразу.

<h2>Библиотека lazysizes</h2>

Чтобы обеспечить кроссбраузерность, то есть совместимость с более старыми браузерами, или такими которые еще не поддерживают это нативно, можно использовать ряд существующих JavaScript библиотек. Одни из самых популярных это lazysizes, vanilla-lazyload и lozad.js. Выбор библиотеки сводится к набору предоставляемых возможностей и личным предпочтениям. Мы разберем библиотеку lazysizes.
<br>
<h4>ИНТЕРЕСНО
Нативная поддержка лучше и более производительна чем использование библиотек, но они гарантированно работают во всех браузерах и могут предоставлять расширенные возможности отложенной загрузки которых еще нет в стандарте.
</h4>
<br>
Первое что необходимо сделать это подключить библиотеку в проект используя сервис cdnjs.com. Тег с ссылкой на скрипт добавляется в конец <body>, также как мы это делали для библиотеки Lodash.

<code>
  
<br>    index.html
<br>body

<br>  script
<br>    src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/
<br>5.3.2/lazysizes.min.js"
<br>    integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et
<br>1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ=="
<br>    crossorigin="anonymous"
<br>    referrerpolicy="no-referrer"
<br>/script
<br>  <!-- Your script file -->
<br>  script defer src="" /script
<br>/body
</code>


<h4>ИНТЕРЕСНО
Библиотека lazysizes самоинициализируется при загрузке на страницу. 
То есть для базового использования в JavaScript ничего делать не надо. 
Полный список её возможностей приведён в документации.</h4>
<br>
Всем изображениям которые необходимо загружать отложенно задаём класс lazyload и заменяем атрибут src на data-src. Это необходимо библиотеке lazysizes для правильной работы.
<br>
<code>
    img class="lazyload" data-src="" alt="Generic alt" /
</code>
<br>
Пока изображение загружается можно показывать заполнитель низкого качества. Эта техника называется LQIP (Low Quality Image Placeholder). Есть много вариантов реализации LQIP, но для начала достаточно будет показывать один стандартный заполнитель вместо всех изображений. Для этого добавляем атрибут src, значением которого будет ссылка на это изображение-заполнитель.
<br><br>
<code>
<br>    img
<br>  class="lazyload"
<br>  src=""
<br>  data-src=""
<br>  alt="Generic alt"
<br>/
</code>
<br>
Когда изображение было загружено, библиотека lazysizes добавляет элементу класс lazyloaded. Это можно использовать для применения CSS-эффектов в момент загрузки изображения.
<br><br>
<code>
<br>    styles.css
<br>.blur-up {
<br>  filter: blur(5px);
<br>  transition: filter 400ms;
<br>}
<br>
<br>.blur-up.lazyloaded {
<br>  filter: blur(0);
<br>}
</code>
<br>
После объявления стилей, добавляем класс blur-up тегам <img>.
<br>
<code>
<br>    index.html
<br>img
<br>  class="lazyload blur-up"
<br>  src=""
<br>  data-src=""
<br>  alt="Generic alt"
<br>/
</code>
<br>
Применим все эти шаги на примере, добавив кроссбраузерную поддержку отложенной загрузки изображений нашему сайту про котов. Теперь даже Safari выполняет отложенную загрузку изображений.
  </p>
</section>

</body>
</html>